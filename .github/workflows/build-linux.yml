name: Build RequestFlow (Linux)

on:
  push:
    branches: [ main, feature/*, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.7.3'
        host: 'linux'
        target: 'desktop'
        arch: 'linux_gcc_64'
        cache: true
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev libglu1-mesa-dev libxkbcommon-x11-0 \
          libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-render-util0 \
          libxcb-xinerama0 libxcb-cursor0 libfuse2 file
        
    - name: Create build directory
      working-directory: RequestFlowApp
      run: mkdir -p build
        
    - name: Configure with qmake
      working-directory: RequestFlowApp/build
      run: qmake ../RequestFlow.pro -r "CONFIG+=release"
        
    - name: Build with make
      working-directory: RequestFlowApp/build
      run: make -j$(nproc)
        
    - name: Prepare AppDir structure
      working-directory: RequestFlowApp/build
      run: |
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/lib
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        
        # Copy main executable
        cp RequestFlow/RequestFlow AppDir/usr/bin/
        
        # Copy project libraries
        cp CoreModel/libCoreModel.so* AppDir/usr/lib/ || true
        cp CoreView/libCoreView.so* AppDir/usr/lib/ || true
        cp ExecutionEngine/libExecutionEngine.so* AppDir/usr/lib/ || true
        
        # List all shared libraries for verification
        echo "Copied libraries:"
        ls -la AppDir/usr/lib/
        
    - name: Create desktop entry
      working-directory: RequestFlowApp/build/AppDir
      run: |
        cat > usr/share/applications/requestflow.desktop << 'DESKTOP'
        [Desktop Entry]
        Type=Application
        Name=RequestFlow
        Exec=RequestFlow
        Icon=requestflow
        Categories=Development;Network;
        Comment=HTTP Request Flow Application
        DESKTOP
        
    - name: Create app icon
      working-directory: RequestFlowApp/build/AppDir
      run: |
        # Create a simple placeholder icon if none exists
        # In a real project, you'd copy your actual icon
        convert -size 256x256 xc:blue usr/share/icons/hicolor/256x256/apps/requestflow.png 2>/dev/null || \
        echo "Icon creation skipped - install imagemagick if needed"
        
    - name: Download linuxdeploy and Qt plugin
      working-directory: RequestFlowApp/build
      run: |
        wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
        chmod +x linuxdeploy*.AppImage
        
    - name: Create AppImage
      working-directory: RequestFlowApp/build
      run: |
        export QMAKE=$Qt6_DIR/bin/qmake
        export PATH=$Qt6_DIR/bin:$PATH
        export LD_LIBRARY_PATH=$Qt6_DIR/lib:$LD_LIBRARY_PATH
        
        ./linuxdeploy-x86_64.AppImage \
          --appdir AppDir \
          --plugin qt \
          --executable AppDir/usr/bin/RequestFlow \
          --desktop-file AppDir/usr/share/applications/requestflow.desktop \
          --icon-file AppDir/usr/share/icons/hicolor/256x256/apps/requestflow.png \
          --output appimage
        
        # Rename the AppImage
        mv RequestFlow*.AppImage ../../RequestFlow-Linux-x86_64.AppImage || true
        
    - name: Verify AppImage
      run: |
        ls -lh RequestFlow-Linux-x86_64.AppImage
        file RequestFlow-Linux-x86_64.AppImage
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: RequestFlow-Linux-x86_64
        path: RequestFlow-Linux-x86_64.AppImage
        retention-days: 30
        
    - name: Upload release asset (on tags)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: RequestFlow-Linux-x86_64.AppImage
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}