name: Build RequestFlow (Linux)

on:
  push:
    branches: [ main, feature/*, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.7.2'
        host: 'linux'
        target: 'desktop'
        arch: 'gcc_64'
        cache: true
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev libglu1-mesa-dev libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-render-util0 libxcb-xinerama0 libxcb-cursor0
        
    - name: Create build directory
      working-directory: RequestFlowApp
      run: mkdir -p build
        
    - name: Configure with qmake
      working-directory: RequestFlowApp/build
      run: qmake ../RequestFlow.pro -r "CONFIG+=release"
        
    - name: Build with make
      working-directory: RequestFlowApp/build
      run: make -j$(nproc)
        
    - name: Copy project libraries
      working-directory: RequestFlowApp/build
      run: |
        mkdir -p RequestFlow/lib
        cp CoreModel/libCoreModel.so* RequestFlow/lib/ || true
        cp CoreView/libCoreView.so* RequestFlow/lib/ || true
        cp ExecutionEngine/libExecutionEngine.so* RequestFlow/lib/ || true
        
    - name: Create launch script
      working-directory: RequestFlowApp/build/RequestFlow
      run: |
        cat > RequestFlow.sh << 'EOF'
        #!/bin/bash
        SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
        export LD_LIBRARY_PATH="${SCRIPT_DIR}/lib:${LD_LIBRARY_PATH}"
        "${SCRIPT_DIR}/RequestFlow" "$@"
        EOF
        chmod +x RequestFlow.sh
        
    - name: Package artifacts
      working-directory: RequestFlowApp/build
      run: tar -czf ../../RequestFlow-Linux-x64.tar.gz RequestFlow/
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: RequestFlow-Linux-x64
        path: RequestFlow-Linux-x64.tar.gz
        retention-days: 30
        
    - name: Upload release asset (on tags)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: RequestFlow-Linux-x64.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
