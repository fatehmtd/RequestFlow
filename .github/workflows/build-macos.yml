name: Build RequestFlow (macOS)

on:
  push:
    branches: [ main, feature/*, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.7.3'
        host: 'mac'
        target: 'desktop'
        arch: 'clang_64'
        cache: true
        
    - name: Create build directory
      working-directory: RequestFlowApp
      run: mkdir -p build
        
    - name: Configure with qmake
      working-directory: RequestFlowApp/build
      run: qmake ../RequestFlow.pro -r "CONFIG+=release"
        
    - name: Build with make
      working-directory: RequestFlowApp/build
      run: make -j$(sysctl -n hw.ncpu)
        
    - name: Deploy Qt dependencies
      working-directory: RequestFlowApp/build/RequestFlow
      run: macdeployqt RequestFlow.app -dmg
        
    - name: Copy project libraries to app bundle
      working-directory: RequestFlowApp/build
      run: |
        cp CoreModel/libCoreModel.*.dylib RequestFlow/RequestFlow.app/Contents/Frameworks/ || true
        cp CoreView/libCoreView.*.dylib RequestFlow/RequestFlow.app/Contents/Frameworks/ || true
        cp ExecutionEngine/libExecutionEngine.*.dylib RequestFlow/RequestFlow.app/Contents/Frameworks/ || true
        
    - name: Package artifacts
      working-directory: RequestFlowApp/build/RequestFlow
      run: |
        mv RequestFlow.dmg ../../../RequestFlow-macOS-x64.dmg
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: RequestFlow-macOS-x64
        path: RequestFlow-macOS-x64.dmg
        retention-days: 30
        
    - name: Upload release asset (on tags)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: RequestFlow-macOS-x64.dmg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
