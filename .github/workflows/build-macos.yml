name: Build RequestFlow (macOS)

on:
  push:
    branches: [ main, feature/*, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.7.3'
        host: 'mac'
        target: 'desktop'
        arch: 'clang_64'
        cache: true
        
    - name: Create build directory
      working-directory: RequestFlowApp
      run: mkdir -p build
        
    - name: Configure with qmake
      working-directory: RequestFlowApp/build
      run: qmake ../RequestFlow.pro -r "CONFIG+=release"
        
    - name: Build with make
      working-directory: RequestFlowApp/build
      run: make -j$(sysctl -n hw.ncpu)
        
    - name: Prepare app bundle
      working-directory: RequestFlowApp/build
      run: |
        # Create frameworks directory in app bundle
        mkdir -p RequestFlow/RequestFlow.app/Contents/Frameworks
        
        # Copy project dylibs
        cp CoreModel/libCoreModel.*.dylib RequestFlow/RequestFlow.app/Contents/Frameworks/ || true
        cp CoreView/libCoreView.*.dylib RequestFlow/RequestFlow.app/Contents/Frameworks/ || true
        cp ExecutionEngine/libExecutionEngine.*.dylib RequestFlow/RequestFlow.app/Contents/Frameworks/ || true
        
        # Also copy versioned symlinks if they exist
        cp -P CoreModel/libCoreModel.dylib RequestFlow/RequestFlow.app/Contents/Frameworks/ 2>/dev/null || true
        cp -P CoreView/libCoreView.dylib RequestFlow/RequestFlow.app/Contents/Frameworks/ 2>/dev/null || true
        cp -P ExecutionEngine/libExecutionEngine.dylib RequestFlow/RequestFlow.app/Contents/Frameworks/ 2>/dev/null || true
        
        # List all dylibs for verification
        echo "Copied dylibs:"
        ls -la RequestFlow/RequestFlow.app/Contents/Frameworks/
        
    - name: Deploy Qt dependencies
      working-directory: RequestFlowApp/build/RequestFlow
      run: |
        macdeployqt RequestFlow.app -verbose=2
        
    - name: Fix library paths
      working-directory: RequestFlowApp/build/RequestFlow
      run: |
        # Fix install names for project libraries
        for lib in RequestFlow.app/Contents/Frameworks/lib*.dylib; do
          if [ -f "$lib" ]; then
            libname=$(basename "$lib")
            install_name_tool -id "@executable_path/../Frameworks/$libname" "$lib" || true
            install_name_tool -change "libCoreModel.1.dylib" "@executable_path/../Frameworks/libCoreModel.1.dylib" "$lib" 2>/dev/null || true
            install_name_tool -change "libCoreView.1.dylib" "@executable_path/../Frameworks/libCoreView.1.dylib" "$lib" 2>/dev/null || true
            install_name_tool -change "libExecutionEngine.1.dylib" "@executable_path/../Frameworks/libExecutionEngine.1.dylib" "$lib" 2>/dev/null || true
          fi
        done
        
        # Fix executable
        install_name_tool -change "libCoreModel.1.dylib" "@executable_path/../Frameworks/libCoreModel.1.dylib" RequestFlow.app/Contents/MacOS/RequestFlow 2>/dev/null || true
        install_name_tool -change "libCoreView.1.dylib" "@executable_path/../Frameworks/libCoreView.1.dylib" RequestFlow.app/Contents/MacOS/RequestFlow 2>/dev/null || true
        install_name_tool -change "libExecutionEngine.1.dylib" "@executable_path/../Frameworks/libExecutionEngine.1.dylib" RequestFlow.app/Contents/MacOS/RequestFlow 2>/dev/null || true
        
    - name: Verify library dependencies
      working-directory: RequestFlowApp/build/RequestFlow
      run: |
        echo "=== Executable dependencies ==="
        otool -L RequestFlow.app/Contents/MacOS/RequestFlow
        echo ""
        echo "=== Project library dependencies ==="
        for lib in RequestFlow.app/Contents/Frameworks/lib*.dylib; do
          if [ -f "$lib" ]; then
            echo "--- $(basename $lib) ---"
            otool -L "$lib"
            echo ""
          fi
        done
        
    - name: Create DMG
      working-directory: RequestFlowApp/build
      run: |
        # Install create-dmg if not available
        brew install create-dmg || true
        
        # Create DMG
        create-dmg \
          --volname "RequestFlow" \
          --volicon "RequestFlow/RequestFlow.app/Contents/Resources/RequestFlow.icns" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "RequestFlow.app" 175 120 \
          --hide-extension "RequestFlow.app" \
          --app-drop-link 425 120 \
          --no-internet-enable \
          "../../RequestFlow-macOS-x86_64.dmg" \
          "RequestFlow/RequestFlow.app" \
          2>/dev/null || \
        hdiutil create -volname RequestFlow -srcfolder RequestFlow/RequestFlow.app -ov -format UDZO ../../RequestFlow-macOS-x86_64.dmg
        
    - name: Verify DMG
      run: |
        ls -lh RequestFlow-macOS-x86_64.dmg
        hdiutil imageinfo RequestFlow-macOS-x86_64.dmg | grep -E "(Format|Size)"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: RequestFlow-macOS-x86_64
        path: RequestFlow-macOS-x86_64.dmg
        retention-days: 30
        
    - name: Upload release asset (on tags)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: RequestFlow-macOS-x86_64.dmg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}